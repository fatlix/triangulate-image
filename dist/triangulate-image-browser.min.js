!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self,t.triangulate=e())}(this,function(){"use strict";function t(t,e,n){return t<e?e:t>n?n:t}function e(t){var e=!1;if(void 0!==t)try{e=JSON.parse(JSON.stringify(t))}catch(t){}return e}function n(t,e,n,r){var a=!(!e||!e.backgroundColor)&&e.backgroundColor,o=new _(t.width*n,t.height*n,r),i=o.getContext("2d");return a&&(i.fillStyle=a,i.fillRect(0,0,t.width*n,t.height*n),i.fillStyle="transparent"),{canvas:o,ctx:i}}function r(t){var e=n({width:1,height:1},{},1,!0).ctx;e.fillStyle=t,e.fillRect(0,0,1,1);var r=e.getImageData(0,0,1,1).data;return{r:r[0],g:r[1],b:r[2],a:r[3]/255}}function a(n){return"object"!=typeof(n=e(n))&&(n={}),"number"!=typeof n.accuracy||isNaN(n.accuracy)?n.accuracy=L.accuracy:n.accuracy=t(n.accuracy,0,1),("number"!=typeof n.blur||isNaN(n.blur))&&(n.blur=L.blur),n.blur<=0&&(n.blur=1),"string"!=typeof n.fill&&"boolean"!=typeof n.fill&&(n.fill=L.fill),"string"!=typeof n.stroke&&"boolean"!=typeof n.stroke&&(n.stroke=L.stroke),("number"!=typeof n.strokeWidth||isNaN(n.strokeWidth))&&(n.strokeWidth=L.strokeWidth),"number"!=typeof n.threshold||isNaN(n.threshold)?n.threshold=L.threshold:n.threshold=t(n.threshold,1,100),"string"==typeof n.lineJoin&&-1!==T.indexOf(n.lineJoin)||(n.lineJoin=L.lineJoin),n.gradients&&n.fill?n.gradients=!0:n.gradients=!1,n.gradients&&(("number"!=typeof n.gradientStops||isNaN(n.gradientStops)||n.gradientStops<2)&&(n.gradientStops=2),n.gradientStops=Math.round(n.gradientStops)),("number"!=typeof n.vertexCount||isNaN(n.vertexCount))&&(n.vertexCount=L.vertexCount),n.vertexCount<=0&&(n.vertexCount=1),"string"!=typeof n.transparentColor&&"boolean"!=typeof n.transparentColor&&(n.transparentColor=L.transparentColor),!0===typeof n.transparentColor&&(n.transparentColor=!1),"string"==typeof n.transparentColor&&(n.transparentColor=r(n.transparentColor)),n}function o(t){if(t instanceof HTMLImageElement){if(!t.naturalWidth||!t.naturalHeight||!1===t.complete)throw new Error("This this image hasn't finished loading: "+t.src);var e=new _(t.naturalWidth,t.naturalHeight),n=e.getContext("2d");n.drawImage(t,0,0,e.width,e.height);var r=n.getImageData(0,0,e.width,e.height);return r.data&&r.data.length&&(void 0===r.width&&(r.width=t.naturalWidth),void 0===r.height&&(r.height=t.naturalHeight)),r}throw new Error("This object does not seem to be an image.")}function i(t){var e=U({a:1},t);return"rgba("+e.r+", "+e.g+", "+e.b+", "+e.a+")"}function u(t,e,n,r){return r=r||1,e.forEach(function(e,n){if(t.beginPath(),t.moveTo(e.a.x*r,e.a.y*r),t.lineTo(e.b.x*r,e.b.y*r),t.lineTo(e.c.x*r,e.c.y*r),t.lineTo(e.a.x*r,e.a.y*r),e.gradient){var a=t.createLinearGradient(e.gradient.x1*r,e.gradient.y1*r,e.gradient.x2*r,e.gradient.y2*r),o=e.gradient.colors.length-1;e.gradient.colors.forEach(function(t,e){var n=i(t);a.addColorStop(e/o,n)}),t.fillStyle=a,t.fill(),e.strokeWidth>0&&(t.strokeStyle=a,t.lineWidth=e.strokeWidth*r,t.lineJoin=e.lineJoin,t.stroke())}else e.fill&&(t.fillStyle=e.fill,t.fill()),e.strokeColor&&(t.strokeStyle=e.strokeColor,t.lineWidth=e.strokeWidth*r,t.lineJoin=e.lineJoin,t.stroke());t.closePath()}),t}function s(t,e,r){var a=r&&r.dpr?r.dpr:1,o=n(e,r,a,!0).ctx;return u(o,t,e,a),o.getImageData(0,0,e.width*a,e.height*a)}function h(t,e,r){var a=r&&r.dpr?r.dpr:1,o=n(e,r,a);return u(o.ctx,t,e,a),o.canvas.toDataURL()}function c(t,e){var n="";t.length&&t[0].gradient&&(n="<defs>");var r="";return t.forEach(function(t,e){var a=t.a,o=t.b,u=t.c;if(r+='<polygon points="'+a.x+","+a.y+" "+o.x+","+o.y+" "+u.x+","+u.y+'"',t.gradient){var s=t.boundingBox,h=((t.gradient.x1-s.x)/s.width*100).toFixed(3),c=((t.gradient.y1-s.y)/s.height*100).toFixed(3),d=((t.gradient.x2-s.x)/s.width*100).toFixed(3),f=((t.gradient.y2-s.y)/s.height*100).toFixed(3);n+='\n\t<linearGradient id="gradient-'+e+'" x1="'+h+'%" y1="'+c+'%" x2="'+d+'%" y2="'+f+'%">';var l=t.gradient.colors.length-1;t.gradient.colors.forEach(function(t,e){var r=i(t),a=(e/l*100).toFixed(3);n+='\n\t\t\t\t\t<stop offset="'+a+'%" stop-color="'+r+'"/>\n\t\t\t\t'}),n+="</linearGradient>",r+=' fill="url(#gradient-'+e+')"',t.strokeWidth>0&&(r+=' stroke="url(#gradient-'+e+')" stroke-width="'+t.strokeWidth+'" stroke-linejoin="'+t.lineJoin+'"')}else t.fill?r+=' fill="'+t.fill+'"':r+=' fill="transparent"',t.strokeColor&&(r+=' stroke="'+t.strokeColor+'" stroke-width="'+t.strokeWidth+'" stroke-linejoin="'+t.lineJoin+'"');r+="/>\n\t"}),n.length&&(n+="\n\t\t</defs>"),'<?xml version="1.0" standalone="yes"?>\n<svg width="'+e.width+'" height="'+e.height+'" xmlns="http://www.w3.org/2000/svg" version="1.1" >\n\t'+n+"\n\t"+r+"\n</svg>"}function d(t,e){return e={exports:{}},t(e,e.exports),e.exports}function f(t){return t&&"number"==typeof t.width&&"number"==typeof t.height&&t.data&&"number"==typeof t.data.length&&"object"==typeof t.data}function l(t){if(f(t)){if("undefined"==typeof Uint8ClampedArray){if("undefined"==typeof window)throw new Error("Can't copy imageData in webworker without Uint8ClampedArray support.");return g(t)}var e=new Uint8ClampedArray(t.data);if("undefined"==typeof ImageData)return{width:t.width,height:t.height,data:e};var n;try{n=new ImageData(e,t.width,t.height)}catch(e){if("undefined"==typeof window)throw new Error("Can't copy imageData in webworker without proper ImageData() support.");n=g(t)}return n}throw new Error("Given imageData object is not useable.")}function g(t){var e=new _(t.width,t.height).getContext("2d");return e.putImageData(t,0,0),e.getImageData(0,0,t.width,t.height)}function y(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}function p(t,e,n,r,a,o){var i,u,s,h,c,d,f,l,g,p,x,m,v,w,b,k,C,D,E,S,W,I,M,B,P=t.data,J=o+o+1,_=r-1,j=a-1,L=o+1,T=L*(L+1)/2,U=new y,A=U;for(s=1;s<J;s++)if(A=A.next=new y,s==L)var R=A;A.next=U;var O=null,V=null;f=d=0;var F=G[o],H=N[o];for(u=0;u<a;u++){for(k=C=D=E=l=g=p=x=0,m=L*(S=P[d]),v=L*(W=P[d+1]),w=L*(I=P[d+2]),b=L*(M=P[d+3]),l+=T*S,g+=T*W,p+=T*I,x+=T*M,A=U,s=0;s<L;s++)A.r=S,A.g=W,A.b=I,A.a=M,A=A.next;for(s=1;s<L;s++)h=d+((_<s?_:s)<<2),l+=(A.r=S=P[h])*(B=L-s),g+=(A.g=W=P[h+1])*B,p+=(A.b=I=P[h+2])*B,x+=(A.a=M=P[h+3])*B,k+=S,C+=W,D+=I,E+=M,A=A.next;for(O=U,V=R,i=0;i<r;i++)P[d+3]=M=x*F>>H,0!=M?(M=255/M,P[d]=(l*F>>H)*M,P[d+1]=(g*F>>H)*M,P[d+2]=(p*F>>H)*M):P[d]=P[d+1]=P[d+2]=0,l-=m,g-=v,p-=w,x-=b,m-=O.r,v-=O.g,w-=O.b,b-=O.a,h=f+((h=i+o+1)<_?h:_)<<2,l+=k+=O.r=P[h],g+=C+=O.g=P[h+1],p+=D+=O.b=P[h+2],x+=E+=O.a=P[h+3],O=O.next,m+=S=V.r,v+=W=V.g,w+=I=V.b,b+=M=V.a,k-=S,C-=W,D-=I,E-=M,V=V.next,d+=4;f+=r}for(i=0;i<r;i++){for(C=D=E=k=g=p=x=l=0,m=L*(S=P[d=i<<2]),v=L*(W=P[d+1]),w=L*(I=P[d+2]),b=L*(M=P[d+3]),l+=T*S,g+=T*W,p+=T*I,x+=T*M,A=U,s=0;s<L;s++)A.r=S,A.g=W,A.b=I,A.a=M,A=A.next;for(c=r,s=1;s<=o;s++)d=c+i<<2,l+=(A.r=S=P[d])*(B=L-s),g+=(A.g=W=P[d+1])*B,p+=(A.b=I=P[d+2])*B,x+=(A.a=M=P[d+3])*B,k+=S,C+=W,D+=I,E+=M,A=A.next,s<j&&(c+=r);for(d=i,O=U,V=R,u=0;u<a;u++)P[(h=d<<2)+3]=M=x*F>>H,M>0?(M=255/M,P[h]=(l*F>>H)*M,P[h+1]=(g*F>>H)*M,P[h+2]=(p*F>>H)*M):P[h]=P[h+1]=P[h+2]=0,l-=m,g-=v,p-=w,x-=b,m-=O.r,v-=O.g,w-=O.b,b-=O.a,h=i+((h=u+L)<j?h:j)*r<<2,l+=k+=O.r=P[h],g+=C+=O.g=P[h+1],p+=D+=O.b=P[h+2],x+=E+=O.a=P[h+3],O=O.next,m+=S=V.r,v+=W=V.g,w+=I=V.b,b+=M=V.a,k-=S,C-=W,D-=I,E-=M,V=V.next,d+=r}return t}function x(t){for(var e,n=t.data.length,r=0;r<n;r+=4)e=.34*t.data[r]+.5*t.data[r+1]+.16*t.data[r+2],t.data[r]=e,t.data[r+1]=e,t.data[r+2]=e;return t}function m(t,e){var n,r,a,o,i,u,s,h,c,d=t.width,f=t.height,l=t.data,g=[];for(r=0;r<f;r+=2)for(n=0;n<d;n+=2){for(h=c=0,a=-1;a<=1;a++)if(u=r+a,s=u*d,u>=0&&u<f)for(o=-1;o<=1;o++)(i=n+o)>=0&&i<d&&(h+=l[i+s<<2],c++);c&&(h/=c),h>e&&g.push({x:n,y:r})}return g}function v(t,e,n){var r=t+"|"+e;n[r]||(n[r]={x:t,y:e}),r=null}function w(t,e,n,r,a){var o={},i=Math.max(~~(e*(1-n)),5),u=Math.round(Math.sqrt(i)),s=~~(r/u),h=~~(a/Math.round(Math.ceil(i/u))),c=0,d=0,f=0;for(f=0;f<a;f+=h)for(d=++c%2==0?~~(s/2):0;d<r;d+=s)d<r&&f<a&&v(~~(d+Math.cos(f)*h),~~(f+Math.sin(d)*s),o);v(0,0,o),v(r-1,0,o),v(r-1,a-1,o),v(0,a-1,o);var l=e-Object.keys(o).length,g=t.length,y=~~(g/l);if(e>0&&y>0){var p=0;for(p=0;p<g;p+=y)v(t[p].x,t[p].y,o)}return t=null,Object.keys(o).map(function(t){return o[t]})}function b(t){var e=1/0,n=-1/0,r=1/0,a=-1/0;return t.forEach(function(t){t.x<e&&(e=t.x),t.y<r&&(r=t.y),t.x>n&&(n=t.x),t.y>a&&(a=t.y)}),{x:e,y:r,width:n-e,height:a-r}}function k(t,e,n){return t.forEach(function(t){t.boundingBox=b([t.a,t.b,t.c])}),t.filter(function(t){return t.boundingBox.width>0&&t.boundingBox.height>0})}function C(e,n,r){var a=(0|t(e.x,1,n.width-2))+(0|t(e.y,1,n.height-2))*n.width<<2;a>=n.data.length&&(a=n.data.length-5);var o=n.data[a+3]/255;return r&&0===o?r:{r:n.data[a],g:n.data[a+1],b:n.data[a+2],a:o}}function D(t){return{x:.33333*(t.a.x+t.b.x+t.c.x),y:.33333*(t.a.y+t.b.y+t.c.y)}}function E(t){return 0===t.a}function S(t,e,n){var r=n.fill,a=n.stroke,o=n.strokeWidth,u=n.lineJoin,s=n.transparentColor,h="string"==typeof r&&r,c="string"==typeof a&&a,d=function(t,e){var n=E(t)&&s,r=n?s:t;return e&&!n?e:i(r)};return t.forEach(function(t){var n=C(D(t),e);r&&(t.fill=d(n,h)),a&&(t.strokeColor=d(n,c),t.strokeWidth=o,t.lineJoin=u)}),t}function W(t){var e=[t.r,t.g,t.b].map(function(t){return t/=255,t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4)});return.2126*e[0]+.7152*e[1]+.0722*e[2]}function I(t,e){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)}function M(t,e,n){return t.forEach(function(t){var r={};"abc".split("").forEach(function(a){var o=C(t[a],e,n.transparentColor);r[a]={key:a,color:o,x:t[a].x,y:t[a].y},r[a].luminance=W(r[a].color);var i="abc".replace(a,"").split("");r[a].median={x:(t[i[0]].x+t[i[1]].x)/2,y:(t[i[0]].y+t[i[1]].y)/2},r[a].medianColor=C(r[a].median,e,n.transparentColor),r[a].medianLuminance=W(r[a].medianColor)});for(var a=[r.a,r.b,r.c].sort(function(t,e){return Math.abs(t.luminance-t.medianLuminance)-Math.abs(e.luminance-e.medianLuminance)}),o=a[0],i=a[0],u=o.median,s=[i],h=I(i,u),c=1,d=n.gradientStops-2;c<d;c++){var f=c*(h/n.gradientStops)/h,l={x:i.x+f*(u.x-i.x),y:i.y+f*(u.y-i.y)};s.push(l)}s.push(u),t.gradient={x1:o.x,y1:o.y,x2:o.median.x,y2:o.median.y,colors:s.map(function(t){return C(t,e,n.transparentColor)})},n.stroke&&(t.strokeWidth=n.strokeWidth,t.lineJoin=n.lineJoin),r=null}),t}function B(t,e){return t.filter(function(t){return!E(C(D(t),e))})}function P(t,e){if(f(t)){var n={width:t.width,height:t.height},r=l(t),a=l(t),o=x(p(r,0,0,n.width,n.height,e.blur)),i=w(m(O(o).toImageData(),e.threshold),e.vertexCount,e.accuracy,n.width,n.height),u=R(i);return u=k(u),e.transparentColor||(u=B(u,a)),u=!0===e.fill&&!0===e.gradients?M(u,a,e):S(u,a,e)}throw new Error("Can't work with the imageData provided. It seems to be corrupt.")}function J(t){function e(){return t}function n(){var t=U({},j);return I||U(t,L),t}function r(){var t=U({},j);return M||U(t,T),t}function i(t){return b(o,t)}function u(t){return b(o,t,!0)}function d(t){return b(function(t){return t},t)}function f(t){return b(function(t){return t},t,!0)}function l(t){return k(function(t){return t},t)}function g(t){return k(function(t){return t},t,!0)}function y(t){return k(h,t)}function p(t){return k(h,t,!0)}function x(t){return k(s,t)}function m(t){return k(s,t,!0)}function v(t){return k(c,t)}function w(t){return k(c,t,!0)}function b(t,e,n){return B=!!n,I=function(){return B?t(e):new Promise(function(n,r){try{n(t(e))}catch(t){r(t)}})},C()?D():r()}function k(t,e,r){return J=!!r,M=function(n,r){return J?t(n,r,e):new Promise(function(a,o){try{a(t(n,r,e))}catch(t){o(t)}})},C()?D():n()}function C(){return I&&M}function D(){if(B&&J){var e=I(t),n=P(e,t);return M(n,e)}return new Promise(function(e,n){var r;E().then(function(e){return r=e,S(r,t)},n).then(function(t){return W(t,r)},n).then(function(t){e(t)},n)})}function E(t){return new Promise(function(e,n){if(B)try{e(I(t))}catch(t){n(t)}else I(t).then(e,n)})}function S(t,e){return new Promise(function(n,r){_.addEventListener("message",function(t){if(t.data&&t.data.polygonJSONStr){var e=JSON.parse(t.data.polygonJSONStr);n(e)}else r(t.data&&t.data.err?t.data.err:t)}),_.postMessage({params:e,imageData:t,imageDataWidth:t.width,imageDataHeight:t.height})})}function W(t,e){return new Promise(function(n,r){if(J)try{n(M(t,e))}catch(t){r(t)}else M(t,e).then(n,r)})}t=a(t);var I,M,B=!1,J=!1,_=new Worker(URL.createObjectURL(new Blob(['function createCommonjsModule(t,a){return a={exports:{}},t(a,a.exports),a.exports}function isImageData(t){return t&&"number"==typeof t.width&&"number"==typeof t.height&&t.data&&"number"==typeof t.data.length&&"object"==typeof t.data}function copyImageData(t){if(isImageData(t)){if("undefined"==typeof Uint8ClampedArray){if("undefined"==typeof window)throw new Error("Can\'t copy imageData in webworker without Uint8ClampedArray support.");return copyImageDataWithCanvas(t)}var a=new Uint8ClampedArray(t.data);if("undefined"==typeof ImageData)return{width:t.width,height:t.height,data:a};var e;try{e=new ImageData(a,t.width,t.height)}catch(a){if("undefined"==typeof window)throw new Error("Can\'t copy imageData in webworker without proper ImageData() support.");e=copyImageDataWithCanvas(t)}return e}throw new Error("Given imageData object is not useable.")}function copyImageDataWithCanvas(t){var a=new Canvas(t.width,t.height).getContext("2d");return a.putImageData(t,0,0),a.getImageData(0,0,t.width,t.height)}function BlurStack(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}function stackblur(t,a,e,n,r,o){var i,s,u,h,c,d,g,l,f,y,p,x,m,v,b,w,C,D,I,E,M,P,B,_,k=t.data,T=o+o+1,A=n-1,j=r-1,S=o+1,U=S*(S+1)/2,V=new BlurStack,W=V;for(u=1;u<T;u++)if(W=W.next=new BlurStack,u==S)var O=W;W.next=V;var J=null,L=null;g=d=0;var G=mul_table[o],R=shg_table[o];for(s=0;s<r;s++){for(w=C=D=I=l=f=y=p=0,x=S*(E=k[d]),m=S*(M=k[d+1]),v=S*(P=k[d+2]),b=S*(B=k[d+3]),l+=U*E,f+=U*M,y+=U*P,p+=U*B,W=V,u=0;u<S;u++)W.r=E,W.g=M,W.b=P,W.a=B,W=W.next;for(u=1;u<S;u++)h=d+((A<u?A:u)<<2),l+=(W.r=E=k[h])*(_=S-u),f+=(W.g=M=k[h+1])*_,y+=(W.b=P=k[h+2])*_,p+=(W.a=B=k[h+3])*_,w+=E,C+=M,D+=P,I+=B,W=W.next;for(J=V,L=O,i=0;i<n;i++)k[d+3]=B=p*G>>R,0!=B?(B=255/B,k[d]=(l*G>>R)*B,k[d+1]=(f*G>>R)*B,k[d+2]=(y*G>>R)*B):k[d]=k[d+1]=k[d+2]=0,l-=x,f-=m,y-=v,p-=b,x-=J.r,m-=J.g,v-=J.b,b-=J.a,h=g+((h=i+o+1)<A?h:A)<<2,l+=w+=J.r=k[h],f+=C+=J.g=k[h+1],y+=D+=J.b=k[h+2],p+=I+=J.a=k[h+3],J=J.next,x+=E=L.r,m+=M=L.g,v+=P=L.b,b+=B=L.a,w-=E,C-=M,D-=P,I-=B,L=L.next,d+=4;g+=n}for(i=0;i<n;i++){for(C=D=I=w=f=y=p=l=0,x=S*(E=k[d=i<<2]),m=S*(M=k[d+1]),v=S*(P=k[d+2]),b=S*(B=k[d+3]),l+=U*E,f+=U*M,y+=U*P,p+=U*B,W=V,u=0;u<S;u++)W.r=E,W.g=M,W.b=P,W.a=B,W=W.next;for(c=n,u=1;u<=o;u++)d=c+i<<2,l+=(W.r=E=k[d])*(_=S-u),f+=(W.g=M=k[d+1])*_,y+=(W.b=P=k[d+2])*_,p+=(W.a=B=k[d+3])*_,w+=E,C+=M,D+=P,I+=B,W=W.next,u<j&&(c+=n);for(d=i,J=V,L=O,s=0;s<r;s++)k[(h=d<<2)+3]=B=p*G>>R,B>0?(B=255/B,k[h]=(l*G>>R)*B,k[h+1]=(f*G>>R)*B,k[h+2]=(y*G>>R)*B):k[h]=k[h+1]=k[h+2]=0,l-=x,f-=m,y-=v,p-=b,x-=J.r,m-=J.g,v-=J.b,b-=J.a,h=i+((h=s+S)<j?h:j)*n<<2,l+=w+=J.r=k[h],f+=C+=J.g=k[h+1],y+=D+=J.b=k[h+2],p+=I+=J.a=k[h+3],J=J.next,x+=E=L.r,m+=M=L.g,v+=P=L.b,b+=B=L.a,w-=E,C-=M,D-=P,I-=B,L=L.next,d+=n}return t}function greyscale(t){for(var a,e=t.data.length,n=0;n<e;n+=4)a=.34*t.data[n]+.5*t.data[n+1]+.16*t.data[n+2],t.data[n]=a,t.data[n+1]=a,t.data[n+2]=a;return t}function getEdgePoints(t,a){var e,n,r,o,i,s,u,h,c,d=t.width,g=t.height,l=t.data,f=[];for(n=0;n<g;n+=2)for(e=0;e<d;e+=2){for(h=c=0,r=-1;r<=1;r++)if(s=n+r,u=s*d,s>=0&&s<g)for(o=-1;o<=1;o++)(i=e+o)>=0&&i<d&&(h+=l[i+u<<2],c++);c&&(h/=c),h>a&&f.push({x:e,y:n})}return f}function clamp(t,a,e){return t<a?a:t>e?e:t}function addVertex(t,a,e){var n=t+"|"+a;e[n]||(e[n]={x:t,y:a}),n=null}function getVerticesFromPoints(t,a,e,n,r){var o={},i=Math.max(~~(a*(1-e)),5),s=Math.round(Math.sqrt(i)),u=~~(n/s),h=~~(r/Math.round(Math.ceil(i/s))),c=0,d=0,g=0;for(g=0;g<r;g+=h)for(d=++c%2==0?~~(u/2):0;d<n;d+=u)d<n&&g<r&&addVertex(~~(d+Math.cos(g)*h),~~(g+Math.sin(d)*u),o);addVertex(0,0,o),addVertex(n-1,0,o),addVertex(n-1,r-1,o),addVertex(0,r-1,o);var l=a-Object.keys(o).length,f=t.length,y=~~(f/l);if(a>0&&y>0){var p=0;for(p=0;p<f;p+=y)addVertex(t[p].x,t[p].y,o)}return t=null,Object.keys(o).map(function(t){return o[t]})}function getBoundingBox(t){var a=1/0,e=-1/0,n=1/0,r=-1/0;return t.forEach(function(t){t.x<a&&(a=t.x),t.y<n&&(n=t.y),t.x>e&&(e=t.x),t.y>r&&(r=t.y)}),{x:a,y:n,width:e-a,height:r-n}}function addBoundingBoxesToPolygons(t,a,e){return t.forEach(function(t){t.boundingBox=getBoundingBox([t.a,t.b,t.c])}),t.filter(function(t){return t.boundingBox.width>0&&t.boundingBox.height>0})}function getColorByPos(t,a,e){var n=(0|clamp(t.x,1,a.width-2))+(0|clamp(t.y,1,a.height-2))*a.width<<2;n>=a.data.length&&(n=a.data.length-5);var r=a.data[n+3]/255;return e&&0===r?e:{r:a.data[n],g:a.data[n+1],b:a.data[n+2],a:r}}function polygonCenter(t){return{x:.33333*(t.a.x+t.b.x+t.c.x),y:.33333*(t.a.y+t.b.y+t.c.y)}}function isTransparent(t){return 0===t.a}function toRGBA(t){var a=objectAssign({a:1},t);return"rgba("+a.r+", "+a.g+", "+a.b+", "+a.a+")"}function addColorToPolygons(t,a,e){var n=e.fill,r=e.stroke,o=e.strokeWidth,i=e.lineJoin,s=e.transparentColor,u="string"==typeof n&&n,h="string"==typeof r&&r,c=function(t,a){var e=isTransparent(t)&&s,n=e?s:t;return a&&!e?a:toRGBA(n)};return t.forEach(function(t){var e=getColorByPos(polygonCenter(t),a);n&&(t.fill=c(e,u)),r&&(t.strokeColor=c(e,h),t.strokeWidth=o,t.lineJoin=i)}),t}function luminance(t){var a=[t.r,t.g,t.b].map(function(t){return t/=255,t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4)});return.2126*a[0]+.7152*a[1]+.0722*a[2]}function distance(t,a){var e=a.x-t.x,n=a.y-t.y;return Math.sqrt(e*e+n*n)}function addGradientsToPolygons(t,a,e){return t.forEach(function(t){var n={};"abc".split("").forEach(function(r){var o=getColorByPos(t[r],a,e.transparentColor);n[r]={key:r,color:o,x:t[r].x,y:t[r].y},n[r].luminance=luminance(n[r].color);var i="abc".replace(r,"").split("");n[r].median={x:(t[i[0]].x+t[i[1]].x)/2,y:(t[i[0]].y+t[i[1]].y)/2},n[r].medianColor=getColorByPos(n[r].median,a,e.transparentColor),n[r].medianLuminance=luminance(n[r].medianColor)});for(var r=[n.a,n.b,n.c].sort(function(t,a){return Math.abs(t.luminance-t.medianLuminance)-Math.abs(a.luminance-a.medianLuminance)}),o=r[0],i=r[0],s=o.median,u=[i],h=distance(i,s),c=1,d=e.gradientStops-2;c<d;c++){var g=c*(h/e.gradientStops)/h,l={x:i.x+g*(s.x-i.x),y:i.y+g*(s.y-i.y)};u.push(l)}u.push(s),t.gradient={x1:o.x,y1:o.y,x2:o.median.x,y2:o.median.y,colors:u.map(function(t){return getColorByPos(t,a,e.transparentColor)})},e.stroke&&(t.strokeWidth=e.strokeWidth,t.lineJoin=e.lineJoin),n=null}),t}function filterTransparentPolygons(t,a){return t.filter(function(t){return!isTransparent(getColorByPos(polygonCenter(t),a))})}function imageDataToPolygons(t,a){if(isImageData(t)){var e={width:t.width,height:t.height},n=copyImageData(t),r=copyImageData(t),o=greyscale(stackblur(n,0,0,e.width,e.height,a.blur)),i=getVerticesFromPoints(getEdgePoints(sobel(o).toImageData(),a.threshold),a.vertexCount,a.accuracy,e.width,e.height),s=delaunay_2(i);return s=addBoundingBoxesToPolygons(s),a.transparentColor||(s=filterTransparentPolygons(s,r)),s=!0===a.fill&&!0===a.gradients?addGradientsToPolygons(s,r,a):addColorToPolygons(s,r,a)}throw new Error("Can\'t work with the imageData provided. It seems to be corrupt.")}var delaunay=createCommonjsModule(function(t){function a(t,a,e){this.a=t,this.b=a,this.c=e;var n,r,o,i,s=a.x-t.x,u=a.y-t.y,h=e.x-t.x,c=e.y-t.y,d=s*(t.x+a.x)+u*(t.y+a.y),g=h*(t.x+e.x)+c*(t.y+e.y),l=2*(s*(e.y-a.y)-u*(e.x-a.x));Math.abs(l)<1e-6?(n=Math.min(t.x,a.x,e.x),r=Math.min(t.y,a.y,e.y),o=.5*(Math.max(t.x,a.x,e.x)-n),i=.5*(Math.max(t.y,a.y,e.y)-r),this.x=n+o,this.y=r+i,this.r=o*o+i*i):(this.x=(c*d-u*g)/l,this.y=(s*g-h*d)/l,o=this.x-t.x,i=this.y-t.y,this.r=o*o+i*i)}function e(t,a){return a.x-t.x}function n(t){var a,e,n,r,o,i=t.length;t:for(;i;)for(e=t[--i],a=t[--i],n=i;n;)if(o=t[--n],r=t[--n],a===r&&e===o||a===o&&e===r){t.splice(i,2),t.splice(n,2),i-=2;continue t}}function r(t){if(t.length<3)return[];t.sort(e);for(var r=t.length-1,o=t[r].x,i=t[0].x,s=t[r].y,u=s;r--;)t[r].y<s&&(s=t[r].y),t[r].y>u&&(u=t[r].y);var h,c,d,g=i-o,l=u-s,f=g>l?g:l,y=.5*(i+o),p=.5*(u+s),x=[new a({x:y-20*f,y:p-f,__sentinel:!0},{x:y,y:p+20*f,__sentinel:!0},{x:y+20*f,y:p-f,__sentinel:!0})],m=[],v=[];for(r=t.length;r--;){for(v.length=0,h=x.length;h--;)(g=t[r].x-x[h].x)>0&&g*g>x[h].r?(m.push(x[h]),x.splice(h,1)):g*g+(l=t[r].y-x[h].y)*l>x[h].r||(v.push(x[h].a,x[h].b,x[h].b,x[h].c,x[h].c,x[h].a),x.splice(h,1));for(n(v),h=v.length;h;)d=v[--h],c=v[--h],x.push(new a(c,d,t[r]))}for(Array.prototype.push.apply(m,x),r=m.length;r--;)(m[r].a.__sentinel||m[r].b.__sentinel||m[r].c.__sentinel)&&m.splice(r,1);return m}a.prototype.draw=function(t){t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.lineTo(this.c.x,this.c.y),t.closePath(),t.stroke()},t.exports={Triangle:a,triangulate:r}}),delaunay_1=delaunay.Triangle,delaunay_2=delaunay.triangulate,sobel=createCommonjsModule(function(t,a){!function(e){function n(t){function a(t){return function(a,e,n){return n=n||0,t[4*(o*e+a)+n]}}if(!(this instanceof n))return new n(t);var e,r,o=t.width,i=t.height,s=[[-1,0,1],[-2,0,2],[-1,0,1]],u=[[-1,-2,-1],[0,0,0],[1,2,1]],h=[],c=[],d=a(t.data);for(r=0;r<i;r++)for(e=0;e<o;e++){var g=(d(e,r,0)+d(e,r,1)+d(e,r,2))/3;c.push(g,g,g,255)}for(d=a(c),r=0;r<i;r++)for(e=0;e<o;e++){var l=s[0][0]*d(e-1,r-1)+s[0][1]*d(e,r-1)+s[0][2]*d(e+1,r-1)+s[1][0]*d(e-1,r)+s[1][1]*d(e,r)+s[1][2]*d(e+1,r)+s[2][0]*d(e-1,r+1)+s[2][1]*d(e,r+1)+s[2][2]*d(e+1,r+1),f=u[0][0]*d(e-1,r-1)+u[0][1]*d(e,r-1)+u[0][2]*d(e+1,r-1)+u[1][0]*d(e-1,r)+u[1][1]*d(e,r)+u[1][2]*d(e+1,r)+u[2][0]*d(e-1,r+1)+u[2][1]*d(e,r+1)+u[2][2]*d(e+1,r+1),y=Math.sqrt(l*l+f*f)>>>0;h.push(y,y,y,255)}var p=h;return"function"==typeof Uint8ClampedArray&&(p=new Uint8ClampedArray(h)),p.toImageData=function(){return n.toImageData(p,o,i)},p}function r(t,a,e){return{width:a,height:e,data:t}}n.toImageData=function(t,a,e){if("function"==typeof ImageData&&"[object Uint16Array]"===Object.prototype.toString.call(t))return new ImageData(t,a,e);if("object"==typeof window&&"object"==typeof window.document){var n=document.createElement("canvas");if("function"==typeof n.getContext){var o=n.getContext("2d").createImageData(a,e);return o.data.set(t),o}return new r(t,a,e)}return new r(t,a,e)},t.exports&&(a=t.exports=n),a.Sobel=n}()}),sobel_1=sobel.Sobel,Canvas=function(t,a){void 0===t&&(t=300),void 0===a&&(a=150),"undefined"==typeof window?(this.canvasEl={width:t,height:a},this.ctx=null):(this.canvasEl=document.createElement("canvas"),this.canvasEl.width=t,this.canvasEl.height=a,this.ctx=this.canvasEl.getContext("2d"))},prototypeAccessors={width:{configurable:!0},height:{configurable:!0}};Canvas.prototype.getContext=function(){return this.ctx},Canvas.prototype.toDataURL=function(t,a,e){if("function"!=typeof e)return this.canvasEl.toDataURL(t,a);e(this.canvasEl.toDataURL(t,a))},prototypeAccessors.width.get=function(){return this.canvasEl.width},prototypeAccessors.width.set=function(t){this.canvasEl.width=t},prototypeAccessors.height.get=function(){return this.canvasEl.height},prototypeAccessors.height.set=function(t){this.canvasEl.height=t},Object.defineProperties(Canvas.prototype,prototypeAccessors),"undefined"!=typeof window&&(Canvas.Image=Image);var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],objectAssign=Object.assign;onmessage=function(t){if(t.data.imageData&&t.data.params)try{var a=t.data.imageData;void 0===a.width&&"number"==typeof t.data.imageDataWidth&&(a.width=t.data.imageDataWidth),void 0===a.height&&"number"==typeof t.data.imageDataHeight&&(a.height=t.data.imageDataHeight);var e=imageDataToPolygons(t.data.imageData,t.data.params);self.postMessage({polygonJSONStr:JSON.stringify(e)})}catch(t){self.postMessage({err:t.message||t})}else t.data.imageData?self.postMessage({err:"Parameters are missing."}):self.postMessage({err:"ImageData is missing."});self.close()};'],{type:"text/javascript"}))),j={getParams:e,getInput:n,getOutput:r},L={fromImage:i,fromImageSync:u,fromImageData:d,fromImageDataSync:f},T={toData:l,toDataSync:g,toDataURL:y,toDataURLSync:p,toImageData:x,toImageDataSync:m,toSVG:v,toSVGSync:w};return n()}var _=function(t,e){void 0===t&&(t=300),void 0===e&&(e=150),"undefined"==typeof window?(this.canvasEl={width:t,height:e},this.ctx=null):(this.canvasEl=document.createElement("canvas"),this.canvasEl.width=t,this.canvasEl.height=e,this.ctx=this.canvasEl.getContext("2d"))},j={width:{configurable:!0},height:{configurable:!0}};_.prototype.getContext=function(){return this.ctx},_.prototype.toDataURL=function(t,e,n){if("function"!=typeof n)return this.canvasEl.toDataURL(t,e);n(this.canvasEl.toDataURL(t,e))},j.width.get=function(){return this.canvasEl.width},j.width.set=function(t){this.canvasEl.width=t},j.height.get=function(){return this.canvasEl.height},j.height.set=function(t){this.canvasEl.height=t},Object.defineProperties(_.prototype,j),"undefined"!=typeof window&&(_.Image=Image);var L={accuracy:.7,blur:4,fill:!0,stroke:!0,strokeWidth:.5,lineJoin:"miter",vertexCount:700,threshold:50,transparentColor:!1},T=["miter","round","bevel"],U=Object.assign,A=d(function(t){function e(t,e,n){this.a=t,this.b=e,this.c=n;var r,a,o,i,u=e.x-t.x,s=e.y-t.y,h=n.x-t.x,c=n.y-t.y,d=u*(t.x+e.x)+s*(t.y+e.y),f=h*(t.x+n.x)+c*(t.y+n.y),l=2*(u*(n.y-e.y)-s*(n.x-e.x));Math.abs(l)<1e-6?(r=Math.min(t.x,e.x,n.x),a=Math.min(t.y,e.y,n.y),o=.5*(Math.max(t.x,e.x,n.x)-r),i=.5*(Math.max(t.y,e.y,n.y)-a),this.x=r+o,this.y=a+i,this.r=o*o+i*i):(this.x=(c*d-s*f)/l,this.y=(u*f-h*d)/l,o=this.x-t.x,i=this.y-t.y,this.r=o*o+i*i)}function n(t,e){return e.x-t.x}function r(t){var e,n,r,a,o,i=t.length;t:for(;i;)for(n=t[--i],e=t[--i],r=i;r;)if(o=t[--r],a=t[--r],e===a&&n===o||e===o&&n===a){t.splice(i,2),t.splice(r,2),i-=2;continue t}}function a(t){if(t.length<3)return[];t.sort(n);for(var a=t.length-1,o=t[a].x,i=t[0].x,u=t[a].y,s=u;a--;)t[a].y<u&&(u=t[a].y),t[a].y>s&&(s=t[a].y);var h,c,d,f=i-o,l=s-u,g=f>l?f:l,y=.5*(i+o),p=.5*(s+u),x=[new e({x:y-20*g,y:p-g,__sentinel:!0},{x:y,y:p+20*g,__sentinel:!0},{x:y+20*g,y:p-g,__sentinel:!0})],m=[],v=[];for(a=t.length;a--;){for(v.length=0,h=x.length;h--;)(f=t[a].x-x[h].x)>0&&f*f>x[h].r?(m.push(x[h]),x.splice(h,1)):f*f+(l=t[a].y-x[h].y)*l>x[h].r||(v.push(x[h].a,x[h].b,x[h].b,x[h].c,x[h].c,x[h].a),x.splice(h,1));for(r(v),h=v.length;h;)d=v[--h],c=v[--h],x.push(new e(c,d,t[a]))}for(Array.prototype.push.apply(m,x),a=m.length;a--;)(m[a].a.__sentinel||m[a].b.__sentinel||m[a].c.__sentinel)&&m.splice(a,1);return m}e.prototype.draw=function(t){t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.lineTo(this.c.x,this.c.y),t.closePath(),t.stroke()},t.exports={Triangle:e,triangulate:a}}),R=(A.Triangle,A.triangulate),O=d(function(t,e){!function(n){function r(t){function e(t){return function(e,n,r){return r=r||0,t[4*(o*n+e)+r]}}if(!(this instanceof r))return new r(t);var n,a,o=t.width,i=t.height,u=[[-1,0,1],[-2,0,2],[-1,0,1]],s=[[-1,-2,-1],[0,0,0],[1,2,1]],h=[],c=[],d=e(t.data);for(a=0;a<i;a++)for(n=0;n<o;n++){var f=(d(n,a,0)+d(n,a,1)+d(n,a,2))/3;c.push(f,f,f,255)}for(d=e(c),a=0;a<i;a++)for(n=0;n<o;n++){var l=u[0][0]*d(n-1,a-1)+u[0][1]*d(n,a-1)+u[0][2]*d(n+1,a-1)+u[1][0]*d(n-1,a)+u[1][1]*d(n,a)+u[1][2]*d(n+1,a)+u[2][0]*d(n-1,a+1)+u[2][1]*d(n,a+1)+u[2][2]*d(n+1,a+1),g=s[0][0]*d(n-1,a-1)+s[0][1]*d(n,a-1)+s[0][2]*d(n+1,a-1)+s[1][0]*d(n-1,a)+s[1][1]*d(n,a)+s[1][2]*d(n+1,a)+s[2][0]*d(n-1,a+1)+s[2][1]*d(n,a+1)+s[2][2]*d(n+1,a+1),y=Math.sqrt(l*l+g*g)>>>0;h.push(y,y,y,255)}var p=h;return"function"==typeof Uint8ClampedArray&&(p=new Uint8ClampedArray(h)),p.toImageData=function(){return r.toImageData(p,o,i)},p}function a(t,e,n){return{width:e,height:n,data:t}}r.toImageData=function(t,e,n){if("function"==typeof ImageData&&"[object Uint16Array]"===Object.prototype.toString.call(t))return new ImageData(t,e,n);if("object"==typeof window&&"object"==typeof window.document){var r=document.createElement("canvas");if("function"==typeof r.getContext){var o=r.getContext("2d").createImageData(e,n);return o.data.set(t),o}return new a(t,e,n)}return new a(t,e,n)},t.exports&&(e=t.exports=r),e.Sobel=r}()}),G=(O.Sobel,[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259]),N=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];return J});